<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store League Table Dashboard</title>
    <!-- Removed Teams SDK for standalone version -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.4;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.2em;
            font-weight: 600;
            color: #1d1d1f;
        }

        .teams-status {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            color: #1976d2;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 0.9em;
            font-weight: 500;
        }

        .upload-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            text-align: center;
            display: none; /* Hidden by default */
        }
        
        .upload-section.show-admin {
            display: block;
        }

        .file-input {
            margin: 15px 0;
        }

        input[type="file"] {
            padding: 8px;
            border: 2px dashed #007AFF;
            border-radius: 8px;
            background: #f8f9fa;
            font-size: 14px;
        }

        .upload-btn, .admin-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 8px;
            transition: background-color 0.2s;
        }

        .upload-btn:hover, .admin-btn:hover {
            background: #0056b3;
        }

        .admin-controls {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            text-align: center;
            display: none;
        }
        
        .admin-notice {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 500;
            font-size: 0.9em;
            display: none;
        }

        .admin-controls.show {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: 700;
            color: #007AFF;
            margin-bottom: 6px;
        }

        .stat-label {
            font-size: 0.85em;
            color: #666;
            font-weight: 500;
        }

        /* League table styles */
        .league-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .league-table th {
            background: #007AFF;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .league-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .league-table tr:last-child td {
            border-bottom: none;
        }

        .movement-up {
            color: #28a745;
        }

        .movement-down {
            color: #dc3545;
        }

        .movement-same {
            color: #6c757d;
        }

        /* Version number style */
        .version {
            text-align: center;
            color: #999;
            font-size: 0.8em;
            margin: 10px 0;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Store League Table Dashboard</h1>
        
        <div class="teams-status" id="teamsStatus">
            ‚ö†Ô∏è Teams not detected - running in standalone mode
        </div>

        <div id="adminNotice" class="admin-notice">
            üîß Admin Mode Active - You have access to data management functions
        </div>

        <div id="uploadSection" class="upload-section">
            <h3>Upload CSV Data</h3>
            <div class="file-input">
                <input type="file" id="csvFile" accept=".csv">
                <button class="upload-btn" onclick="handleFileUpload()">Upload & Process</button>
            </div>
        </div>

        <div id="adminControls" class="admin-controls">
            <h3>Admin Controls</h3>
            <button class="admin-btn" onclick="clearData()">Clear All Data</button>
            <button class="admin-btn" onclick="exportData()">Export Current Data</button>
            <button class="admin-btn" onclick="saveDataJson()">Save data.json File</button>
            <button class="admin-btn" onclick="resetRankings()">Reset Rankings</button>
            <button class="admin-btn" onclick="viewUploadHistory()">View Upload History</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalStores">0</div>
                <div class="stat-label">Total Stores</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgParticipation">0%</div>
                <div class="stat-label">Average Participation</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="topStore">-</div>
                <div class="stat-label">Top Performing Store</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="lastUpdated">-</div>
                <div class="stat-label">Last Updated</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="daysData">0</div>
                <div class="stat-label">Days Data</div>
            </div>
        </div>

        <div class="second-row-grid">
            <div class="top-bottom-section">
                <h3 class="section-title">Top 3 Stores</h3>
                <div id="topStores"></div>
            </div>

            <div class="top-bottom-section">
                <h3 class="section-title">Bottom 3 Stores</h3>
                <div id="bottomStores"></div>
            </div>

            <div class="movers-section">
                <h3 class="section-title">Move on Yesterday</h3>
                <div id="biggestMovers"></div>
            </div>
        </div>

        <div class="main-table-section">
            <h3 class="section-title">Complete League Table</h3>
            <div style="overflow-x: auto;">
                <table class="league-table" id="leagueTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Store</th>
                            <th>Participation %</th>
                            <th>Movement</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Hidden admin activation (triple-click to toggle) -->
        <div class="version" onclick="if(event.detail === 3) toggleAdminMode()">v2.0</div>
    </div>

    <script>
        let isAdminUser = false;
        let currentData = [];
        let previousData = [];
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAccess();
            loadSavedData();
        });

        function checkAdminAccess() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Multiple ways to enable admin mode:
            // 1. URL parameter ?admin=1
            // 2. Running locally (file:// protocol)
            // 3. localStorage flag (persistent admin mode)
            
            isAdminUser = 
                urlParams.get('admin') === '1' || 
                window.location.protocol === 'file:' || // Auto-admin when running locally
                window.location.hostname === 'localhost' || // Auto-admin on localhost
                window.location.hostname === '127.0.0.1' || // Auto-admin on localhost
                localStorage.getItem('adminMode') === 'true'; // Persistent admin mode
            
            if (isAdminUser) {
                document.getElementById('adminNotice').style.display = 'block';
                document.getElementById('uploadSection').classList.add('show-admin');
                document.getElementById('adminControls').classList.add('show');
                // Store admin mode in localStorage for persistence
                localStorage.setItem('adminMode', 'true');
            }
        }

        function toggleAdminMode() {
            if (isAdminUser) {
                localStorage.removeItem('adminMode');
                isAdminUser = false;
                document.getElementById('adminNotice').style.display = 'none';
                document.getElementById('uploadSection').classList.remove('show-admin');
                document.getElementById('adminControls').classList.remove('show');
            } else {
                localStorage.setItem('adminMode', 'true');
                isAdminUser = true;
                document.getElementById('adminNotice').style.display = 'block';
                document.getElementById('uploadSection').classList.add('show-admin');
                document.getElementById('adminControls').classList.add('show');
            }
        }

        async function loadSavedData() {
            try {
                const response = await fetch('data.json');
                if (response.ok) {
                    const data = await response.json();
                    currentData = data.currentData || [];
                    previousData = data.previousData || [];
                    updateDashboard();
                    return true;
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
            return false;
        }

        function handleFileUpload() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvData = e.target.result;
                    processCSV(csvData);
                } catch (error) {
                    alert('Error processing file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function processCSV(csvContent) {
            // Store current data as previous
            previousData = [...currentData];
            
            // Parse CSV
            const lines = csvContent.split('\n');
            const headers = lines[0].split(',');
            
            currentData = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',');
                const store = {
                    store: values[0].trim(),
                    participation: parseFloat(values[1]),
                    areaCode: values[2].trim(),
                    lastRank: i,
                    movement: 0
                };
                
                currentData.push(store);
            }
            
            // Calculate movements
            calculateMovements();
            updateDashboard();
            
            // Save to localStorage
            saveData();
            
            alert('Data processed successfully!');
        }

        function calculateMovements() {
            currentData.forEach(store => {
                const prevStore = previousData.find(p => p.store === store.store);
                if (prevStore) {
                    store.movement = prevStore.rank - store.lastRank;
                }
            });
        }

        function updateDashboard() {
            if (!currentData.length) {
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="4" class="no-data">Upload CSV data to view league table</td></tr>';
                return;
            }
            
            // Sort by participation
            currentData.sort((a, b) => b.participation - a.participation);
            
            // Update stats
            document.getElementById('totalStores').textContent = currentData.length;
            document.getElementById('avgParticipation').textContent = (currentData.reduce((sum, store) => sum + store.participation, 0) / currentData.length).toFixed(1) + '%';
            document.getElementById('topStore').textContent = currentData[0].store;
            document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString();
            
            // Update table
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            currentData.forEach((store, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${store.store}</td>
                    <td>${store.participation}%</td>
                    <td class="${store.movement > 0 ? 'movement-up' : store.movement < 0 ? 'movement-down' : 'movement-same'}">
                        ${store.movement > 0 ? '‚¨Ü' : store.movement < 0 ? '‚¨á' : '‚ûñ'} ${Math.abs(store.movement)}
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Update top/bottom stores
            updateTopBottomStores();
        }

        function updateTopBottomStores() {
            const topStores = currentData.slice(0, 3);
            const bottomStores = currentData.slice(-3).reverse();
            
            document.getElementById('topStores').innerHTML = topStores.map(store => `
                <div class="store-item">
                    <span class="store-rank">${currentData.indexOf(store) + 1}</span>
                    <span class="store-name">${store.store}</span>
                    <span class="store-participation">${store.participation}%</span>
                </div>
            `).join('');
            
            document.getElementById('bottomStores').innerHTML = bottomStores.map(store => `
                <div class="store-item">
                    <span class="store-rank">${currentData.indexOf(store) + 1}</span>
                    <span class="store-name">${store.store}</span>
                    <span class="store-participation">${store.participation}%</span>
                </div>
            `).join('');
            
            // Update movers
            const biggestMovers = [...currentData]
                .sort((a, b) => Math.abs(b.movement) - Math.abs(a.movement))
                .slice(0, 3);
            
            document.getElementById('biggestMovers').innerHTML = biggestMovers.map(store => `
                <div class="store-item">
                    <span class="store-name">${store.store}</span>
                    <span class="store-participation ${store.movement > 0 ? 'movement-up' : 'movement-down'}">
                        ${store.movement > 0 ? '‚¨Ü' : '‚¨á'} ${Math.abs(store.movement)}
                    </span>
                </div>
            `).join('');
        }

        function saveData() {
            const data = {
                currentData,
                previousData,
                lastUpdated: new Date().toISOString(),
                daysData: 1
            };
            localStorage.setItem('leagueData', JSON.stringify(data));
        }

        function clearData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                localStorage.removeItem('leagueData');
                currentData = [];
                previousData = [];
                updateDashboard();
            }
        }

        function exportData() {
            const data = {
                currentData,
                previousData,
                lastUpdated: new Date().toISOString(),
                daysData: 1
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'league_data_' + new Date().toISOString().split('T')[0] + '.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function saveDataJson() {
            const data = {
                currentData,
                previousData,
                lastUpdated: new Date().toISOString(),
                daysData: 1
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'data.json';
            a.click();
            
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>