<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incentive Rankings Dashboard - Dynamic Filtering</title>
    <style>
        /* Original styles remain the same */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏆 Incentive Rankings Dashboard</h1>
            <p>Performance Analysis with Dynamic Area Filtering</p>
        </div>

        <div class="filter-notice">
            📋 Results filtered to 178 stores from official store list
        </div>
        
        <div class="filter-notice" style="background: linear-gradient(45deg, var(--warning-color), #e0a800);">
            🎯 Movement shows change after adding Peak - Dewalt incentive (5th incentive)
        </div>

        <!-- Admin Notice -->
        <div id="adminNotice" class="admin-notice">
            🔧 Admin Mode Active - You have access to data management functions
        </div>

        <!-- Admin Controls -->
        <div id="adminControls" class="admin-controls">
            <h3>Admin Controls</h3>
            <div style="margin-top: 15px;">
                <label for="fileInput" style="display: block; margin-bottom: 10px; font-weight: 600;">
                    Upload New Data (CSV Format):
                    <br>
                    <small style="font-weight: normal; color: #666;">
                        Required columns: Store, AM, Incentive, Points
                    </small>
                </label>
                <input type="file" id="fileInput" accept=".csv,.json">
                <button class="admin-btn" onclick="processUploadedFile()">📤 Upload Data</button>
            </div>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                <button class="admin-btn" onclick="exportData()">📊 Export Current Data</button>
                <button class="admin-btn" onclick="clearAllData()">🗑️ Clear All Data</button>
                <button class="admin-btn" onclick="refreshData()">🔄 Refresh Data</button>
                <button class="admin-btn" onclick="toggleEditMode()">✏️ Edit Mode</button>
                <button class="admin-btn" onclick="toggleAdminMode()" style="background: var(--danger-color);">🔒 Hide Admin Panel</button>
            </div>
        </div>

        <!-- Filter Controls -->
        <div class="filter-container">
            <div class="filter-group">
                <label>👥 Filter by Area Manager:</label>
                <select id="amFilter" onchange="filterByAM()">
                    <option value="">All Area Managers</option>
                </select>
            </div>
            <div class="filter-group">
                <span id="filterStatus">Showing: <strong id="visibleCount">0</strong> stores</span>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="statIncentives">5</div>
                <div class="stat-label">Total Incentives</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statStores">0</div>
                <div class="stat-label">Participating Stores</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statWinner">-</div>
                <div class="stat-label">Overall Leader</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="card">
            <h2>Overall Performance Rankings</h2>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th id="areaRankHeader" style="display: none;">Area Rank</th>
                            <th>Movement</th>
                            <th>Location</th>
                            <th>Area Manager</th>
                            <th>Total Points</th>
                            <th>Points by Incentive...</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="6">No data available</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Version for admin toggle -->
        <div style="text-align: center; margin-top: 20px;">
            <small style="color: #666; cursor: pointer;" onclick="if(event.detail === 3) toggleAdminMode()" title="Triple-click to toggle admin mode">v2.0</small>
        </div>
    </div>

    <script>
        // Store data and admin state
        let storeData = {};
        let isAdminUser = false;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAccess();
            loadSavedData();
            setupAMFilter();
            updateTable();
        });

        function checkAdminAccess() {
            const urlParams = new URLSearchParams(window.location.search);
            isAdminUser = 
                urlParams.get('admin') === '1' || 
                window.location.protocol === 'file:' ||
                window.location.hostname === 'localhost' ||
                window.location.hostname === '127.0.0.1' ||
                localStorage.getItem('adminMode') === 'true';
            
            if (isAdminUser) {
                document.getElementById('adminNotice').style.display = 'block';
                document.getElementById('adminControls').style.display = 'block';
                localStorage.setItem('adminMode', 'true');
            }
        }

        function toggleAdminMode() {
            if (isAdminUser) {
                localStorage.removeItem('adminMode');
                isAdminUser = false;
                document.getElementById('adminNotice').style.display = 'none';
                document.getElementById('adminControls').style.display = 'none';
            } else {
                localStorage.setItem('adminMode', 'true');
                isAdminUser = true;
                document.getElementById('adminNotice').style.display = 'block';
                document.getElementById('adminControls').style.display = 'block';
            }
        }

        function loadSavedData() {
            const savedData = localStorage.getItem('storeData');
            if (savedData) {
                try {
                    storeData = JSON.parse(savedData);
                    updateTable();
                } catch (error) {
                    console.error('Error loading saved data:', error);
                }
            }
        }

        function processUploadedFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to upload');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                if (file.name.endsWith('.json')) {
                    try {
                        const newData = JSON.parse(content);
                        Object.assign(storeData, newData);
                        localStorage.setItem('storeData', JSON.stringify(storeData));
                        alert('JSON data uploaded successfully!');
                        location.reload();
                    } catch (err) {
                        alert('Error parsing JSON: ' + err.message);
                    }
                } else if (file.name.endsWith('.csv')) {
                    try {
                        // Process CSV
                        const lines = content.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim());
                        
                        // Validate headers
                        if (!headers.includes('Store') || !headers.includes('AM') || !headers.includes('Incentive')) {
                            alert('CSV must have Store, AM, and Incentive columns');
                            return;
                        }
                        
                        const newData = {};
                        
                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;
                            
                            const values = lines[i].split(',').map(v => v.trim());
                            const store = values[headers.indexOf('Store')];
                            const am = values[headers.indexOf('AM')];
                            const incentive = values[headers.indexOf('Incentive')];
                            const points = parseInt(values[headers.indexOf('Points')] || '0');
                            
                            if (!store || !am || !incentive) continue;
                            
                            if (!newData[store]) {
                                newData[store] = {
                                    am: am,
                                    points: {},
                                    originalRank: i,
                                    originalMovement: 0
                                };
                            }
                            
                            newData[store].points[incentive] = points;
                        }
                        
                        // Merge with existing data
                        Object.assign(storeData, newData);
                        localStorage.setItem('storeData', JSON.stringify(storeData));
                        alert('CSV data processed successfully!');
                        location.reload();
                    } catch (err) {
                        alert('Error processing CSV: ' + err.message);
                    }
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                // Clear all data except admin mode
                const adminMode = localStorage.getItem('adminMode');
                localStorage.clear();
                if (adminMode) localStorage.setItem('adminMode', adminMode);
                
                // Reset store data
                storeData = {};
                
                // Update the UI
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="6">No data available</td></tr>';
                document.getElementById('visibleCount').textContent = '0';
                document.getElementById('statStores').textContent = '0';
                document.getElementById('statWinner').textContent = '-';
                
                alert('All data has been cleared!');
                location.reload();
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(storeData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileName = 'incentive_data_' + new Date().toISOString().split('T')[0] + '.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileName);
            linkElement.click();
        }

        function refreshData() {
            location.reload();
        }

        function toggleEditMode() {
            alert('Edit mode is coming soon!');
        }

        function setupAMFilter() {
            const amList = new Set();
            Object.values(storeData).forEach(store => {
                if (store.am) amList.add(store.am);
            });
            
            const amFilter = document.getElementById('amFilter');
            amFilter.innerHTML = '<option value="">All Area Managers</option>';
            
            [...amList].sort().forEach(am => {
                const option = document.createElement('option');
                option.value = am;
                option.textContent = am;
                amFilter.appendChild(option);
            });
        }

        function updateTable() {
            const stores = Object.entries(storeData).map(([name, data]) => ({
                name,
                ...data
            }));
            
            if (!stores.length) {
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="6">No data available</td></tr>';
                return;
            }
            
            // Update stats
            document.getElementById('statStores').textContent = stores.length;
            document.getElementById('visibleCount').textContent = stores.length;
            
            // Sort stores by total points
            stores.sort((a, b) => {
                const aPoints = Object.values(a.points).reduce((sum, p) => sum + (p < 999 ? p : 0), 0);
                const bPoints = Object.values(b.points).reduce((sum, p) => sum + (p < 999 ? p : 0), 0);
                return aPoints - bPoints;
            });
            
            // Update table
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = stores.map((store, index) => {
                const totalPoints = Object.values(store.points).reduce((sum, p) => sum + (p < 999 ? p : 0), 0);
                const movement = store.originalMovement;
                const movementClass = movement > 0 ? 'movement-up' : movement < 0 ? 'movement-down' : 'movement-same';
                const movementIcon = movement > 0 ? '⬆' : movement < 0 ? '⬇' : '➖';
                
                return `
                    <tr class="data-row" data-am="${store.am}">
                        <td class="rank-cell">${index + 1}</td>
                        <td class="area-rank-cell" style="display: none;">-</td>
                        <td class="movement-cell">
                            <span class="movement-indicator ${movementClass}">
                                ${movementIcon} ${Math.abs(movement)}
                            </span>
                        </td>
                        <td class="location-cell">${store.name}</td>
                        <td class="am-cell">${store.am}</td>
                        <td style="text-align: center; font-weight: bold;">${totalPoints}</td>
                        ${Object.entries(store.points).map(([incentive, points]) => 
                            `<td style="text-align: center;">${points}</td>`
                        ).join('')}
                    </tr>
                `;
            }).join('');
            
            // Update winner
            if (stores.length > 0) {
                document.getElementById('statWinner').textContent = stores[0].name;
            }
        }

        function filterByAM() {
            const selectedAM = document.getElementById('amFilter').value;
            const allRows = document.querySelectorAll('.data-row');
            
            if (!selectedAM) {
                allRows.forEach(row => row.style.display = '');
                document.getElementById('areaRankHeader').style.display = 'none';
                document.querySelectorAll('.area-rank-cell').forEach(cell => cell.style.display = 'none');
                document.getElementById('visibleCount').textContent = allRows.length;
            } else {
                let visibleCount = 0;
                document.getElementById('areaRankHeader').style.display = '';
                document.getElementById('areaRankHeader').textContent = `${selectedAM} Rank`;
                
                allRows.forEach(row => {
                    const isMatch = row.getAttribute('data-am') === selectedAM;
                    row.style.display = isMatch ? '' : 'none';
                    if (isMatch) visibleCount++;
                    
                    const rankCell = row.querySelector('.area-rank-cell');
                    rankCell.style.display = isMatch ? '' : 'none';
                    if (isMatch) rankCell.textContent = visibleCount;
                });
                
                document.getElementById('visibleCount').textContent = visibleCount;
            }
        }
    </script>
</body>
</html>