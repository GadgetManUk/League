<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incentive Rankings Dashboard - Dynamic Filtering</title>
    <style>
        :root {
            --primary-color: #007AFF;
            --primary-dark: #0056b3;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --dark-text: #1d1d1f;
            --light-text: #666;
            --border-color: #e9ecef;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --shadow-hover: 0 6px 25px rgba(0,0,0,0.12);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark-text);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .filter-notice {
            background: linear-gradient(45deg, var(--primary-color), var(--info-color));
            color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 10px 0;
            text-align: center;
            font-weight: 600;
        }

        .admin-notice {
            background: linear-gradient(45deg, var(--success-color), #1e7e34);
            color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 10px 0;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        .admin-controls {
            background: var(--light-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 20px 0;
            display: none;
        }

        .admin-controls h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .admin-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            margin: 5px;
            font-size: 1em;
            transition: var(--transition);
        }

        .admin-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .filter-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 20px;
            background: var(--light-bg);
            border-radius: var(--border-radius);
        }

        .filter-group select {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            margin-left: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--light-text);
            font-size: 0.9em;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin: 20px 0;
            overflow: hidden;
        }

        .card h2 {
            padding: 20px;
            margin: 0;
            background: var(--light-bg);
            color: var(--primary-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: var(--light-bg);
        }

        .rank-cell {
            width: 80px;
            text-align: center;
            font-weight: bold;
        }

        .movement-cell {
            width: 100px;
            text-align: center;
        }

        .movement-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
        }

        .movement-up {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
        }

        .movement-down {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
        }

        .movement-same {
            background: var(--light-bg);
            color: var(--light-text);
        }

        .location-cell {
            font-weight: 600;
        }

        .am-cell {
            color: var(--info-color);
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filter-container {
                flex-direction: column;
                gap: 15px;
            }

            .admin-controls button {
                width: 100%;
                margin: 5px 0;
            }

            table {
                font-size: 0.9em;
            }

            th, td {
                padding: 10px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÜ Incentive Rankings Dashboard</h1>
            <p>Performance Analysis with Dynamic Area Filtering</p>
        </div>

        <div class="filter-notice">
            üìã Results filtered to 178 stores from official store list
        </div>
        
        <div class="filter-notice" style="background: linear-gradient(45deg, var(--warning-color), #e0a800);">
            üéØ Movement shows change after adding Peak - Dewalt incentive (5th incentive)
        </div>

        <!-- Admin Notice -->
        <div id="adminNotice" class="admin-notice">
            üîß Admin Mode Active - You have access to data management functions
        </div>

        <!-- Admin Controls -->
        <div id="adminControls" class="admin-controls">
            <h3>Admin Controls</h3>
            <div style="margin-top: 15px;">
                <label for="fileInput" style="display: block; margin-bottom: 10px; font-weight: 600;">
                    Upload New Data (CSV Format):
                    <br>
                    <small style="font-weight: normal; color: #666;">
                        Required columns: Store, AM, Incentive, Points
                    </small>
                </label>
                <input type="file" id="fileInput" accept=".csv,.json">
                <button class="admin-btn" onclick="processUploadedFile()">üì§ Upload Data</button>
            </div>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                <button class="admin-btn" onclick="exportData()">üìä Export Current Data</button>
                <button class="admin-btn" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                <button class="admin-btn" onclick="refreshData()">üîÑ Refresh Data</button>
                <button class="admin-btn" onclick="toggleEditMode()">‚úèÔ∏è Edit Mode</button>
                <button class="admin-btn" onclick="toggleAdminMode()" style="background: var(--danger-color);">üîí Hide Admin Panel</button>
            </div>
        </div>

        <!-- Filter Controls -->
        <div class="filter-container">
            <div class="filter-group">
                <label>üë• Filter by Area Manager:</label>
                <select id="amFilter" onchange="filterByAM()">
                    <option value="">All Area Managers</option>
                </select>
            </div>
            <div class="filter-group">
                <span id="filterStatus">Showing: <strong id="visibleCount">0</strong> stores</span>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="statIncentives">5</div>
                <div class="stat-label">Total Incentives</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statStores">0</div>
                <div class="stat-label">Participating Stores</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statWinner">-</div>
                <div class="stat-label">Overall Leader</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="card">
            <h2>Overall Performance Rankings</h2>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th id="areaRankHeader" style="display: none;">Area Rank</th>
                            <th>Movement</th>
                            <th>Location</th>
                            <th>Area Manager</th>
                            <th>Total Points</th>
                            <th>Points by Incentive...</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="6">No data available</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Version for admin toggle -->
        <div style="text-align: center; margin-top: 20px;">
            <small style="color: #666; cursor: pointer;" onclick="if(event.detail === 3) toggleAdminMode()" title="Triple-click to toggle admin mode">v2.0</small>
        </div>
    </div>

    <script>
        // Store data and admin state
        let storeData = {};
        let isAdminUser = false;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAccess();
            loadSavedData();
            setupAMFilter();
            updateTable();
        });

        function checkAdminAccess() {
            const urlParams = new URLSearchParams(window.location.search);
            isAdminUser = 
                urlParams.get('admin') === '1' || 
                window.location.protocol === 'file:' ||
                window.location.hostname === 'localhost' ||
                window.location.hostname === '127.0.0.1' ||
                localStorage.getItem('adminMode') === 'true';
            
            if (isAdminUser) {
                document.getElementById('adminNotice').style.display = 'block';
                document.getElementById('adminControls').style.display = 'block';
                localStorage.setItem('adminMode', 'true');
            }
        }

        function toggleAdminMode() {
            if (isAdminUser) {
                localStorage.removeItem('adminMode');
                isAdminUser = false;
                document.getElementById('adminNotice').style.display = 'none';
                document.getElementById('adminControls').style.display = 'none';
            } else {
                localStorage.setItem('adminMode', 'true');
                isAdminUser = true;
                document.getElementById('adminNotice').style.display = 'block';
                document.getElementById('adminControls').style.display = 'block';
            }
        }

        function loadSavedData() {
            const savedData = localStorage.getItem('storeData');
            if (savedData) {
                try {
                    storeData = JSON.parse(savedData);
                    updateTable();
                } catch (error) {
                    console.error('Error loading saved data:', error);
                }
            }
        }

        function processUploadedFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                try {
                    if (file.name.endsWith('.json')) {
                        // Handle JSON upload
                        const newData = JSON.parse(content);
                        Object.assign(storeData, newData);
                    } else if (file.name.endsWith('.csv')) {
                        // Handle CSV upload
                        const lines = content.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim());
                        
                        if (!headers.includes('Store') || !headers.includes('AM') || !headers.includes('Incentive') || !headers.includes('Points')) {
                            alert('CSV must have Store, AM, Incentive, and Points columns');
                            return;
                        }
                        
                        const storeIndex = headers.indexOf('Store');
                        const amIndex = headers.indexOf('AM');
                        const incentiveIndex = headers.indexOf('Incentive');
                        const pointsIndex = headers.indexOf('Points');
                        
                        // Process each line
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            const values = line.split(',').map(v => v.trim());
                            const store = values[storeIndex];
                            const am = values[amIndex];
                            const incentive = values[incentiveIndex];
                            const points = parseInt(values[pointsIndex]);
                            
                            if (!store || !am || !incentive || isNaN(points)) continue;
                            
                            if (!storeData[store]) {
                                storeData[store] = {
                                    am: am,
                                    points: {},
                                    originalRank: Object.keys(storeData).length + 1,
                                    originalMovement: 0
                                };
                            }
                            
                            storeData[store].points[incentive] = points;
                        }
                    }
                    
                    // Save and update
                    localStorage.setItem('storeData', JSON.stringify(storeData));
                    setupAMFilter();
                    updateTable();
                    alert('Data processed successfully!');
                } catch (error) {
                    alert('Error processing file: ' + error.message);
                }
            };
            reader.readAsText(file);
                        // Validate headers
                        if (!headers.includes('Store') || !headers.includes('AM') || !headers.includes('Incentive')) {
                            alert('CSV must have Store, AM, and Incentive columns');
                            return;
                        }
                        
                        const newData = {};
                        
                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;
                            
                            const values = lines[i].split(',').map(v => v.trim());
                            const store = values[headers.indexOf('Store')];
                            const am = values[headers.indexOf('AM')];
                            const incentive = values[headers.indexOf('Incentive')];
                            const points = parseInt(values[headers.indexOf('Points')] || '0');
                            
                            if (!store || !am || !incentive) continue;
                            
                            if (!newData[store]) {
                                newData[store] = {
                                    am: am,
                                    points: {},
                                    originalRank: i,
                                    originalMovement: 0
                                };
                            }
                            
                            newData[store].points[incentive] = points;
                        }
                        
                        // Merge with existing data
                        Object.assign(storeData, newData);
                        localStorage.setItem('storeData', JSON.stringify(storeData));
                        alert('CSV data processed successfully!');
                        location.reload();
                    } catch (err) {
                        alert('Error processing CSV: ' + err.message);
                    }
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                // Clear all data except admin mode
                const adminMode = localStorage.getItem('adminMode');
                localStorage.clear();
                if (adminMode) localStorage.setItem('adminMode', adminMode);
                
                // Reset store data
                storeData = {};
                
                // Update the UI
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="6">No data available</td></tr>';
                document.getElementById('visibleCount').textContent = '0';
                document.getElementById('statStores').textContent = '0';
                document.getElementById('statWinner').textContent = '-';
                
                alert('All data has been cleared!');
                location.reload();
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(storeData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileName = 'incentive_data_' + new Date().toISOString().split('T')[0] + '.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileName);
            linkElement.click();
        }

        function refreshData() {
            location.reload();
        }

        function toggleEditMode() {
            alert('Edit mode is coming soon!');
        }

        function setupAMFilter() {
            const amList = new Set();
            Object.values(storeData).forEach(store => {
                if (store.am) amList.add(store.am);
            });
            
            const amFilter = document.getElementById('amFilter');
            amFilter.innerHTML = '<option value="">All Area Managers</option>';
            
            [...amList].sort().forEach(am => {
                const option = document.createElement('option');
                option.value = am;
                option.textContent = am;
                amFilter.appendChild(option);
            });
        }

        function updateTable() {
            const stores = Object.entries(storeData).map(([name, data]) => ({
                name,
                ...data
            }));
            
            if (!stores.length) {
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="6">No data available</td></tr>';
                return;
            }
            
            // Update stats
            document.getElementById('statStores').textContent = stores.length;
            document.getElementById('visibleCount').textContent = stores.length;
            
            // Sort stores by total points
            stores.sort((a, b) => {
                const aPoints = Object.values(a.points).reduce((sum, p) => sum + (p < 999 ? p : 0), 0);
                const bPoints = Object.values(b.points).reduce((sum, p) => sum + (p < 999 ? p : 0), 0);
                return aPoints - bPoints;
            });
            
            // Update table
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = stores.map((store, index) => {
                const totalPoints = Object.values(store.points).reduce((sum, p) => sum + (p < 999 ? p : 0), 0);
                const movement = store.originalMovement;
                const movementClass = movement > 0 ? 'movement-up' : movement < 0 ? 'movement-down' : 'movement-same';
                const movementIcon = movement > 0 ? '‚¨Ü' : movement < 0 ? '‚¨á' : '‚ûñ';
                
                return `
                    <tr class="data-row" data-am="${store.am}">
                        <td class="rank-cell">${index + 1}</td>
                        <td class="area-rank-cell" style="display: none;">-</td>
                        <td class="movement-cell">
                            <span class="movement-indicator ${movementClass}">
                                ${movementIcon} ${Math.abs(movement)}
                            </span>
                        </td>
                        <td class="location-cell">${store.name}</td>
                        <td class="am-cell">${store.am}</td>
                        <td style="text-align: center; font-weight: bold;">${totalPoints}</td>
                        ${Object.entries(store.points).map(([incentive, points]) => 
                            `<td style="text-align: center;">${points}</td>`
                        ).join('')}
                    </tr>
                `;
            }).join('');
            
            // Update winner
            if (stores.length > 0) {
                document.getElementById('statWinner').textContent = stores[0].name;
            }
        }

        function filterByAM() {
            const selectedAM = document.getElementById('amFilter').value;
            const allRows = document.querySelectorAll('.data-row');
            
            if (!selectedAM) {
                allRows.forEach(row => row.style.display = '');
                document.getElementById('areaRankHeader').style.display = 'none';
                document.querySelectorAll('.area-rank-cell').forEach(cell => cell.style.display = 'none');
                document.getElementById('visibleCount').textContent = allRows.length;
            } else {
                let visibleCount = 0;
                document.getElementById('areaRankHeader').style.display = '';
                document.getElementById('areaRankHeader').textContent = `${selectedAM} Rank`;
                
                allRows.forEach(row => {
                    const isMatch = row.getAttribute('data-am') === selectedAM;
                    row.style.display = isMatch ? '' : 'none';
                    if (isMatch) visibleCount++;
                    
                    const rankCell = row.querySelector('.area-rank-cell');
                    rankCell.style.display = isMatch ? '' : 'none';
                    if (isMatch) rankCell.textContent = visibleCount;
                });
                
                document.getElementById('visibleCount').textContent = visibleCount;
            }
        }
    </script>
</body>
</html>